<!-- Adminpanel.html â€” includes Central/Disp stock tables, PO actions; uses adminListSizes | v0.8.4 | 2025-10-27 -->
<?var __EXEC = EXEC_URL, __UID = (UID||''), __ROLE = (ROLE||''); ?>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"><title>Adminpanel</title><meta name="viewport" content="width=device-width, initial-scale=1">
  <script>window.__EXEC_URL="<?= __EXEC ?>";window.__UID="<?= __UID ?>";window.__ROLE="<?= __ROLE ?>";</script>
  <style>
    body{margin:0;background:#0e1512;color:#e6f0ec;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .wrap{padding:16px} h2{margin:16px 0 8px 0}
    table{border-collapse:collapse;width:100%;background:#0f1a16} th,td{border:1px solid #1b2c26;padding:6px 8px;font-size:.92rem}
    th{background:#13221d;color:#cfe5dd;text-align:left} .grid{display:grid;gap:16px} .g2{grid-template-columns:1fr 1fr}
    .btn{appearance:none;border:0;border-radius:8px;padding:.5rem .7rem;background:#2da37e;color:#05130f;font-weight:600;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap} .card{padding:12px;border:1px solid #16352b;border-radius:10px;background:#0f1a16}
    input,select{background:#0b1a15;color:#e6f0ec;border:1px solid #27433a;border-radius:8px;padding:.45rem .6rem} .muted{color:#9cc6b8}
  </style>
</head>
<body>
  <?!= include('TopNav') ?>
  <div class="wrap grid g2">
    <!-- Users, Dispensaries, Products identical to v0.8.3 ... omitted for brevity -->
    <div class="card"><div class="row"><h2>SizeCatalog</h2><button class="btn" onclick="loadSizes()">Reload</button></div>
      <table id="tblSizes"><thead><tr><th>SizeCode</th><th>Label</th><th>Width(mm)</th><th>Height(mm)</th><th>Guide(g)</th><th>Max(g)</th><th>Active</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card"><div class="row"><h2>PackagingCatalog</h2><button class="btn" onclick="loadPackCat()">Reload</button></div>
      <table id="tblPackCat"><thead><tr><th>Type</th><th>Size</th><th>Label</th><th>Guide(g)</th><th>Max(g)</th><th>Active</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card"><div class="row"><h2>PackagingStock</h2><button class="btn" onclick="loadPackStock()">Reload</button></div>
      <table id="tblPackStock"><thead><tr><th>Type</th><th>Size</th><th>Count</th><th>Updated</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card"><div class="row"><h2>Packaging PO</h2><button class="btn" onclick="loadPO()">Reload</button></div>
      <table id="tblPackPO"><thead><tr><th>POID</th><th>DispID</th><th>Type</th><th>Size</th><th>Qty</th><th>Status</th><th>Requested</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card"><div class="row"><h2>CentralStock</h2><button class="btn" onclick="loadCentral()">Reload</button></div>
      <table id="tblCentral"><thead><tr><th>SKU</th><th>Qty</th><th>Updated</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card"><div class="row"><h2>DispensaryStock</h2><button class="btn" onclick="loadDispStock()">Reload</button></div>
      <table id="tblDispStock"><thead><tr><th>DispID</th><th>SKU</th><th>Qty</th><th>Updated</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card"><div class="row"><h2>Orders</h2><button class="btn" onclick="loadOrders()">Reload</button></div>
      <table id="tblOrders"><thead><tr><th>OrderID</th><th>DispID</th><th>SKU</th><th>Qty</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card"><div class="row"><h2>Sales</h2><button class="btn" onclick="loadSales()">Reload</button></div>
      <table id="tblSales"><thead><tr><th>SaleID</th><th>DispID</th><th>UID</th><th>Customer</th><th>Total</th><th>Created</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <script>
    function setRows(sel, rows, pick){ const tb=document.querySelector(sel); if(!tb) return;
      tb.innerHTML=rows.map(pick).map(tr=>'<tr>'+tr.map(td=>'<td>'+td+'</td>').join('')+'</tr>').join(''); }

    // Sizes/Catalogs/Stock
    function loadSizes(){ google.script.run.withSuccessHandler(list=>{ setRows('#tblSizes tbody',list||[],x=>[x.SizeCode,x.Label,x.WidthMM,x.HeightMM,x.GuideGrams,x.MaxGrams,x.Active?'1':'0']); }).withFailureHandler(console.error).adminListSizes(); }
    function loadPackCat(){ google.script.run.withSuccessHandler(list=>{ setRows('#tblPackCat tbody',list||[],x=>[x.PackageType,x.SizeCode,x.Label,x.GuideGrams,x.MaxGrams,x.Active?'1':'0']); }).withFailureHandler(console.error).adminListPackagingSizes(); }
    function loadPackStock(){ google.script.run.withSuccessHandler(list=>{ setRows('#tblPackStock tbody',list||[],x=>[x.PackageType,x.SizeCode,x.CountAvailable,x.UpdatedISO]); }).withFailureHandler(console.error).adminListPackagingStock(); }
    function loadPO(){ google.script.run.withSuccessHandler(list=>{ setRows('#tblPackPO tbody',list||[],x=>{
      const act=(x.Status==='REQUESTED'||x.Status==='APPROVED')?(`<button class="btn" onclick="poApprove('${x.POID}')">Approve</button> <button class="btn" onclick="poFulfill('${x.POID}')">Fulfill</button>`):'';
      return [x.POID,x.DispID,x.PackageType,x.SizeCode,x.Qty,x.Status,x.CreatedISO,act];
    }); }).withFailureHandler(console.error).adminListPackagingPO(); }
    function poApprove(id){ google.script.run.withSuccessHandler(_=>loadPO()).withFailureHandler(alert).adminApprovePackagingPO(id); }
    function poFulfill(id){ const q=Number(prompt('Qty (blank=all):','')||'0'); google.script.run.withSuccessHandler(_=>{loadPO();loadPackStock();}).withFailureHandler(alert).adminFulfillPackagingPO(id,q||undefined); }

    // Stocks
    function loadCentral(){ google.script.run.withSuccessHandler(list=>{ setRows('#tblCentral tbody',list||[],x=>[x.SKU,x.QtyAvailable,x.UpdatedISO]); }).withFailureHandler(console.error).adminListCentralStock(); }
    function loadDispStock(){ google.script.run.withSuccessHandler(list=>{ setRows('#tblDispStock tbody',list||[],x=>[x.DispensaryID,x.SKU,x.QtyAvailable,x.UpdatedISO]); }).withFailureHandler(console.error).adminListDispensaryStock(); }

    // Orders
    function loadOrders(){ google.script.run.withSuccessHandler(list=>{
      setRows('#tblOrders tbody',list||[],x=>{
        const act=(x.Status==='REQUESTED'||x.Status==='APPROVED')?(`<button class="btn" onclick="approve('${x.OrderID}')">Approve</button> <button class="btn" onclick="fulfill('${x.OrderID}')">Fulfill</button>`):'';
        return [x.OrderID,x.DispensaryID,x.SKU,x.Qty,x.Status,x.CreatedISO,act];
      });
    }).withFailureHandler(console.error).adminListOrders(); }
    function approve(orderId){ google.script.run.withSuccessHandler(_=>loadOrders()).withFailureHandler(alert).adminApproveOrder(orderId,window.__UID); }
    function fulfill(orderId){ const q=Number(prompt('Qty (blank=remain):','')||'0');
      google.script.run.withSuccessHandler(_=>{ loadOrders(); loadCentral(); loadDispStock(); }).withFailureHandler(alert).adminFulfillOrder(orderId,q||undefined); }

    // Sales
    function loadSales(){ google.script.run.withSuccessHandler(list=>{ setRows('#tblSales tbody',list||[],x=>[x.SaleID,x.DispensaryID,x.UID,x.CustomerUID,(Number(x.Total||0)).toFixed(2),x.CreatedISO]); }).withFailureHandler(console.error).adminListSales(); }

    document.addEventListener('DOMContentLoaded', function(){
      loadSizes(); loadPackCat(); loadPackStock(); loadPO(); loadCentral(); loadDispStock(); loadOrders(); loadSales();
    });
  </script>
</body>
</html>
